name: CI - Quality and Test Gates

on:
  push:
    branches: ["*"]
  pull_request:
    branches: [main, master]

env:
  PYTHON_VERSION: "3.12"
  PYTHONPATH: ./src
  STREAMLIT_CACHE_DISABLED: "1"

jobs:
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Ruff (wave scope)
        run: |
          ruff check \
            src/ui/queries \
            src/ui/sidebar/query_handler.py \
            src/data/services/storage_sync_service.py \
            src/data/services/sync_data_refresh_service.py \
            src/data/services/sync_types.py \
            src/core/dependencies.py

      - name: Mypy (wave scope)
        run: |
          mypy \
            src/ui/queries \
            src/ui/sidebar/query_handler.py \
            src/data/services/storage_sync_service.py \
            src/data/services/sync_data_refresh_service.py \
            src/data/services/sync_types.py \
            src/core/dependencies.py \
            --ignore-missing-imports

      - name: Security scan
        continue-on-error: true
        run: |
          pip-audit -r requirements.txt || true
          bandit -r src/ -ll -q || true

  unit-tests:
    name: Unit and Integration Gates
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Critical regression suite
        run: |
          export PYTHONPATH="./src:$PYTHONPATH"
          pytest --tb=short --maxfail=1 -x \
            tests/test_cli.py \
            tests/test_fetch_table.py \
            tests/test_connection_leaks.py \
            tests/test_ui_utils.py \
            tests/test_views.py

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Install Playwright browsers
        run: playwright install --with-deps

      - name: Start Streamlit app
        run: |
          export PYTHONPATH="./src:$PYTHONPATH"
          streamlit run src/ui/data_refresh.py --server.port 8501 &
          sleep 20
          curl -f http://localhost:8501

      - name: Run E2E tests
        run: |
          export PYTHONPATH="./src:$PYTHONPATH"
          pytest -m e2e --base-url http://localhost:8501 --timeout=300

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality, unit-tests, e2e-tests]
    if: always()

    steps:
      - name: Build summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Quality: ${{ needs.quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit/Integration: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
